<!doctype html>
<html lang="en">
<%- include('../partials/head') %>
   <link rel="stylesheet" href="/css/login.css">

   <body>
      <div class="container text-center">
         <div class="row">
            <div class="col">
               <!-- Content here -->
               <div class="container d-flex justify-content-center align-items-center min-vh-100">
                  <div class="row border rounded-5 p-3 bg-white shadow box-area" style="min-height: 520px;">
                     <div
                        class="col-md-6 rounded-4 d-flex justify-content-center align-items-center flex-column left-box"
                        style="background: #099584;">
                        <div class="featured-image mb-3">
                           <img src="/images/Vaccine development-bro.png" class="img-fluid" style="width: 300px;">
                        </div>
                        <p class="text-white fs-5 mb-1">¡Hola de nuevo!</p>
                        <small class="text-white text-wrap text-center">
                           Ingresa tu correo y contraseña para empezar.
                        </small>
                     </div>
                     <div class="col-md-6 right-box">
                        <form id="loginForm" action="/auth/login" method="POST"
                           class="d-flex justify-content-between flex-column h-100 needs-validation" novalidate>
                           <div class="d-flex flex-column">
                              <div class="header-text mb-3 text-start">
                                 <h2 class="fw-bold">Hola de nuevo!</h2>
                                 <p class="mb-0">Nos alegramos de tenerte de vuelta.</p>
                              </div>
                              <!-- Nombre -->
                              <div class="input-group mb-3">
                                 <input type="text" class="form-control form-control-lg bg-light fs-6" disabled readonly
                                    style="border-color: transparent; background-color: transparent !important;">
                              </div>
                              <!-- Correo -->
                              <div class="input-group mb-3">
                                 <input type="text" class="form-control form-control-lg bg-light fs-6"
                                    placeholder="Correo electrónico" name="email" autocomplete="username" required autofocus>
                              </div>
                              <!-- Contraseña -->
                              <div class="input-group mb-3">
                                 <input type="password" class="form-control form-control-lg bg-light fs-6"
                                    placeholder="Contraseña" name="password" autocomplete="current-password" required>
                              </div>
                              <!-- Confirmar contraseña -->
                              <div class="input-group mb-3">
                                 <input class="form-control form-control-lg bg-light fs-6" disabled readonly
                                    style="border-color: transparent; background-color: transparent !important;">
                              </div>
                           </div>
                           <div class="d-flex flex-column">
                              <div class="input-group mb-3">
                                 <button class="btn btn-lg w-100 fs-6" type="submit"
                                    style="background-color: #099584; color: #FFFFFF;">
                                    Iniciar sesión
                                 </button>
                              </div>
                              <div class="row">
                                 <small>¿No tienes cuenta? <a href="/auth/register">Regístrate</a></small>
                              </div>
                           </div>
                        </form>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      </div>
      <%- include('../partials/scripts') %>
         <script>
            $(document).on("submit", "#loginForm", function (e) {
               e.preventDefault();

               const $submitBtn = $(this).find('button[type="submit"]');

               if (validarFormulario(this.id)) {
                  console.log("✅ Formulario válido");

                  $.ajax({
                     url: $(this).attr("action"),
                     method: $(this).attr("method"),
                     data: $(this).serialize(),
                     beforeSend: function () {
                        // Desactivar el botón antes de enviar
                        $submitBtn.prop('disabled', true).text('Procesando...');
                     }
                  }).done(function (response) {
                     if (response.success) {
                        window.location.href = "/tamizajes";
                     }
                  }).fail(function (xhr, status, error) {
                     console.warn("⚠️ Error HTTP:", xhr.status, error);
                     let msg = "Ocurrió un error inesperado.";

                     if (xhr.status === 400) msg = "Email y contraseña son obligatorios.";
                     else if (xhr.status === 401) msg = "Credenciales incorrectas.";
                     else if (xhr.status === 403) msg = "Acceso denegado.";
                     else if (xhr.status === 404) msg = "Usuario no encontrado.";
                     else if (xhr.status === 500) msg = "Error interno del servidor.";

                     Toast.fire({
                        icon: "error",
                        title: msg
                     });
                  }).always(function () {
                     // Volver a activar el botón después de terminar
                     $submitBtn.prop('disabled', false).text('Iniciar sesión');
                  });
               } else {
                  console.log("❌ Formulario inválido");
                  Toast.fire({
                     icon: "error",
                     title: "Formulario inválido",
                     text: "Por favor, completa todos los campos requeridos."
                  });
               }
            });
         </script>
   </body>

</html>